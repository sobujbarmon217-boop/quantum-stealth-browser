name: Quantum Stealth Windows Installer

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-installer:
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download Chromium Windows
      shell: powershell
      run: |
        Write-Host "Downloading Chromium..."
        Invoke-WebRequest -Uri "https://download-chromium.appspot.com/dl/Win_x64?type=snapshots" -OutFile "chromium-win.zip"
        Expand-Archive chromium-win.zip -DestinationPath chromium-extracted
        Move-Item chromium-extracted/chrome-win build-files
        Write-Host "Download complete"

    - name: Install Build Tools
      shell: powershell
      run: |
        choco install -y nsis imagemagick.app

    - name: Apply Custom Logos
      shell: powershell
      run: |
        if (Test-Path "branding/logos") {
          Copy-Item branding/logos/*.png build-files/ -ErrorAction SilentlyContinue
          Write-Host "Logos copied"
          
          # Create icon if logo exists
          if (Test-Path "branding/logos/product_logo_256.png") {
            magick convert branding/logos/product_logo_256.png build-files/quantum-stealth.ico
            Write-Host "Icon created"
          }
        }

    - name: Apply Branding Patches
      shell: powershell
      run: |
        Get-ChildItem -Path build-files -Filter *.pak -Recurse | ForEach-Object {
          (Get-Content $_.FullName -Raw -Encoding Byte) -replace [byte[]][char[]]'Chromium', [byte[]][char[]]'Quantum Stealth' | Set-Content $_.FullName -Encoding Byte
          (Get-Content $_.FullName -Raw -Encoding Byte) -replace [byte[]][char[]]'Google Chrome', [byte[]][char[]]'Quantum Stealth' | Set-Content $_.FullName -Encoding Byte
        }
        Write-Host "Branding applied to .pak files"

    - name: Download Resource Hacker
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "http://www.angusj.com/resourcehacker/resource_hacker.zip" -OutFile "reshacker.zip"
        Expand-Archive reshacker.zip -DestinationPath reshacker
        Write-Host "Resource Hacker ready"

    - name: Modify Chrome Executable
      shell: powershell
      run: |
        if (Test-Path "build-files/quantum-stealth.ico") {
          .\reshacker\ResourceHacker.exe -open build-files\chrome.exe -save build-files\chrome_branded.exe -action addoverwrite -res build-files\quantum-stealth.ico -mask ICONGROUP,1,
          Move-Item build-files\chrome_branded.exe build-files\chrome.exe -Force
          Write-Host "Icon embedded in chrome.exe"
        }

    - name: Create NSIS Installer Script
      shell: powershell
      run: |
        @"
        !define PRODUCT_NAME "Quantum Stealth Browser"
        !define PRODUCT_VERSION "1.0.0"
        !define PRODUCT_PUBLISHER "Quantum Technologies"
        
        SetCompressor lzma
        Name "`${PRODUCT_NAME}"
        OutFile "QuantumStealth-Setup.exe"
        InstallDir "`$PROGRAMFILES64\QuantumStealth"
        
        Section "MainSection" SEC01
          SetOutPath "`$INSTDIR"
          File /r "build-files\*.*"
          CreateShortcut "`$DESKTOP\Quantum Stealth.lnk" "`$INSTDIR\chrome.exe"
          CreateShortcut "`$SMPROGRAMS\Quantum Stealth.lnk" "`$INSTDIR\chrome.exe"
        SectionEnd
        "@ | Out-File -FilePath installer.nsi -Encoding ASCII

    - name: Build Installer
      shell: powershell
      run: |
        & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
        if (Test-Path "QuantumStealth-Setup.exe") {
          Write-Host "Installer created successfully!"
          Get-Item QuantumStealth-Setup.exe | Select-Object Name, Length
        }

    - name: Create Installation Guide
      shell: powershell
      run: |
        @"
        QUANTUM STEALTH BROWSER - INSTALLATION GUIDE
        
        System Requirements:
        - Windows 10/11 (64-bit)
        - 4GB RAM minimum
        - 500MB disk space
        
        Installation Steps:
        1. Run QuantumStealth-Setup.exe
        2. Follow installation wizard
        3. Launch from Desktop shortcut
        
        Features:
        - Custom Quantum Stealth branding
        - Privacy patches applied
        - Automation detection removed
        - Fingerprint resistance enabled
        
        Support: https://github.com/sobujbarmon217-boop/quantum-stealth-browser
        "@ | Out-File -FilePath INSTALL-GUIDE.txt -Encoding UTF8

    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: quantum-stealth-windows-installer
        path: QuantumStealth-Setup.exe
        retention-days: 30

    - name: Upload Installation Guide
      uses: actions/upload-artifact@v4
      with:
        name: installation-guide
        path: INSTALL-GUIDE.txt
        retention-days: 30
