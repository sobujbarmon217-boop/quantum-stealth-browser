name: Quantum Stealth Windows Installer

on:
  workflow_dispatch:

jobs:
  build-installer:
    runs-on: windows-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download Chromium Windows
      shell: powershell
      run: |
        Write-Host "Downloading Chromium for Windows..."
        $ProgressPreference = 'SilentlyContinue'
        
        # Download latest Chromium snapshot
        $url = "https://download-chromium.appspot.com/dl/Win_x64?type=snapshots"
        Invoke-WebRequest -Uri $url -OutFile chromium-win.zip
        
        Write-Host "Download complete. Extracting..."
        Expand-Archive -Path chromium-win.zip -DestinationPath chromium-extracted
        
        # Find chrome-win folder
        $chromePath = Get-ChildItem -Path chromium-extracted -Recurse -Directory -Filter "chrome-win" | Select-Object -First 1
        Write-Host "Chrome found at: $($chromePath.FullName)"
        
        # Move to predictable location
        Move-Item $chromePath.FullName -Destination build-files
        
        Write-Host "Extraction complete!"
        Get-ChildItem build-files | Select-Object Name
    
    - name: Install Required Tools
      shell: powershell
      run: |
        Write-Host "Installing NSIS..."
        choco install nsis -y
        
        Write-Host "Installing ImageMagick..."
        choco install imagemagick -y
        
        Write-Host "Tools installed!"
    
    - name: Apply Custom Logos
      shell: powershell
      run: |
        Write-Host "Applying Quantum Stealth logos..."
        
        if (Test-Path "branding/logos") {
          # Copy PNG logos
          Copy-Item branding/logos/*.png build-files/ -ErrorAction SilentlyContinue
          
          # Convert largest logo to ICO for installer icon
          if (Test-Path "branding/logos/product_logo_256.png") {
            magick convert "branding/logos/product_logo_256.png" `
              -define icon:auto-resize=256,128,64,48,32,16 `
              "build-files/quantum-stealth.ico"
            Write-Host "Icon created successfully!"
          }
        } else {
          Write-Host "No custom logos found, using defaults"
        }
    
    - name: Apply Branding Patches
      shell: powershell
      run: |
        Write-Host "Applying text branding..."
        
        # Apply simple text replacements in PAK files
        Get-ChildItem build-files -Filter "*.pak" | ForEach-Object {
          try {
            $content = Get-Content $_.FullName -Raw -Encoding Byte
            $text = [System.Text.Encoding]::UTF8.GetString($content)
            
            # Replace branding
            $text = $text -replace 'Chromium', 'Quantum Stealth'
            $text = $text -replace 'Google Chrome', 'Quantum Stealth'
            
            $bytes = [System.Text.Encoding]::UTF8.GetBytes($text)
            [System.IO.File]::WriteAllBytes($_.FullName, $bytes)
            
            Write-Host "Patched: $($_.Name)"
          } catch {
            Write-Host "Skipped: $($_.Name)"
          }
        }
        
        Write-Host "Branding applied!"
    
    - name: Download Resource Hacker
      shell: powershell
      run: |
        Write-Host "Downloading Resource Hacker..."
        Invoke-WebRequest -Uri "http://www.angusj.com/resourcehacker/resource_hacker.zip" -OutFile rh.zip
        Expand-Archive -Path rh.zip -DestinationPath resource-hacker
        Write-Host "Resource Hacker ready!"
    
    - name: Modify Chrome EXE
      shell: powershell
      run: |
        Write-Host "Customizing chrome.exe..."
        
        $rh = "resource-hacker\ResourceHacker.exe"
        $chromeExe = "build-files\chrome.exe"
        
        # Backup original
        Copy-Item $chromeExe "$chromeExe.backup"
        
        # Replace icon if custom icon exists
        if (Test-Path "build-files\quantum-stealth.ico") {
          & $rh -open $chromeExe -save $chromeExe -action addoverwrite `
            -res "build-files\quantum-stealth.ico" -mask ICONGROUP,1,
          Write-Host "Icon replaced in chrome.exe"
        }
        
        Write-Host "EXE customization complete!"
    
    - name: Create Installer Script
      shell: powershell
      run: |
        Write-Host "Creating NSIS installer script..."
        
        $script = @"
!define APP_NAME "Quantum Stealth Browser"
!define COMP_NAME "Quantum Technologies"  
!define WEB_SITE "https://github.com/sobujbarmon217-boop/quantum-stealth-browser"
!define VERSION "1.0.0.0"
!define COPYRIGHT "Quantum Technologies © 2025"
!define DESCRIPTION "Privacy-focused Chromium-based browser"
!define INSTALLER_NAME "QuantumStealth-Setup.exe"
!define MAIN_APP_EXE "chrome.exe"
!define INSTALL_TYPE "SetShellVarContext all"
!define REG_ROOT "HKLM"
!define REG_APP_PATH "Software\Microsoft\Windows\CurrentVersion\App Paths\${MAIN_APP_EXE}"
!define UNINSTALL_PATH "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APP_NAME}"

######################################################################

VIProductVersion  "${VERSION}"
VIAddVersionKey "ProductName"  "${APP_NAME}"
VIAddVersionKey "CompanyName"  "${COMP_NAME}"
VIAddVersionKey "LegalCopyright"  "${COPYRIGHT}"
VIAddVersionKey "FileDescription"  "${DESCRIPTION}"
VIAddVersionKey "FileVersion"  "${VERSION}"

######################################################################

SetCompressor LZMA
Name "${APP_NAME}"
Caption "${APP_NAME}"
OutFile "${INSTALLER_NAME}"
BrandingText "${APP_NAME}"
XPStyle on
InstallDir "`$PROGRAMFILES64\Quantum Stealth"
InstallDirRegKey "${REG_ROOT}" "${REG_APP_PATH}" ""

######################################################################

!include "MUI2.nsh"

!define MUI_ABORTWARNING
!define MUI_UNABORTWARNING
!define MUI_ICON "build-files\quantum-stealth.ico"

!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES
!insertmacro MUI_UNPAGE_FINISH

!insertmacro MUI_LANGUAGE "English"

######################################################################

Section "Install"
  ${INSTALL_TYPE}
  SetOutPath "`$INSTDIR"
  
  SetOverwrite ifnewer
  File /r "build-files\*.*"
  
  # Create shortcuts
  CreateDirectory "`$SMPROGRAMS\Quantum Stealth"
  CreateShortCut "`$SMPROGRAMS\Quantum Stealth\Quantum Stealth.lnk" "`$INSTDIR\${MAIN_APP_EXE}"
  CreateShortCut "`$DESKTOP\Quantum Stealth.lnk" "`$INSTDIR\${MAIN_APP_EXE}"
  CreateShortCut "`$SMPROGRAMS\Quantum Stealth\Uninstall.lnk" "`$INSTDIR\uninstall.exe"
  
  # Registry entries
  WriteRegStr ${REG_ROOT} "${REG_APP_PATH}" "" "`$INSTDIR\${MAIN_APP_EXE}"
  WriteRegStr ${REG_ROOT} "${UNINSTALL_PATH}" "DisplayName" "${APP_NAME}"
  WriteRegStr ${REG_ROOT} "${UNINSTALL_PATH}" "UninstallString" "`$INSTDIR\uninstall.exe"
  WriteRegStr ${REG_ROOT} "${UNINSTALL_PATH}" "DisplayIcon" "`$INSTDIR\${MAIN_APP_EXE}"
  WriteRegStr ${REG_ROOT} "${UNINSTALL_PATH}" "DisplayVersion" "${VERSION}"
  WriteRegStr ${REG_ROOT} "${UNINSTALL_PATH}" "Publisher" "${COMP_NAME}"
  
  WriteUninstaller "`$INSTDIR\uninstall.exe"
SectionEnd

######################################################################

Section "Uninstall"
  ${INSTALL_TYPE}
  
  Delete "`$INSTDIR\*.*"
  Delete "`$INSTDIR\uninstall.exe"
  RMDir /r "`$INSTDIR"
  
  Delete "`$SMPROGRAMS\Quantum Stealth\*.*"
  RMDir "`$SMPROGRAMS\Quantum Stealth"
  Delete "`$DESKTOP\Quantum Stealth.lnk"
  
  DeleteRegKey ${REG_ROOT} "${REG_APP_PATH}"
  DeleteRegKey ${REG_ROOT} "${UNINSTALL_PATH}"
SectionEnd
"@
        
        $script | Out-File -FilePath installer.nsi -Encoding ASCII
        Write-Host "Installer script created!"
        Get-Content installer.nsi | Select-Object -First 20
    
    - name: Build Installer
      shell: powershell
      run: |
        Write-Host "Building installer with NSIS..."
        
        & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
        
        if (Test-Path "QuantumStealth-Setup.exe") {
          Write-Host "Installer built successfully!"
          $size = (Get-Item QuantumStealth-Setup.exe).Length / 1MB
          Write-Host "Installer size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "ERROR: Installer build failed!"
          exit 1
        }
    
    - name: Create Installation Guide
      shell: powershell
      run: |
        @"
# Quantum Stealth Browser - Windows Installation Guide

## System Requirements:
- Windows 10 or Windows 11
- 64-bit system
- 4GB RAM minimum
- 500MB disk space

## Installation Steps:

1. **Download** QuantumStealth-Setup.exe from Artifacts
2. **Right-click** on the installer → Run as Administrator
3. **Follow** the installation wizard
4. **Launch** from Desktop or Start Menu

## Features:
✅ Custom Quantum Stealth branding
✅ Privacy-focused patches applied
✅ Automation detection removed
✅ Fingerprint resistance enabled

## Uninstallation:
- Go to Settings → Apps → Quantum Stealth Browser → Uninstall
- Or run uninstall.exe from installation folder

## Support:
https://github.com/sobujbarmon217-boop/quantum-stealth-browser/issues

## License:
Chromium: BSD License
Custom Patches: MIT License

---
Built with GitHub Actions
© 2025 Quantum Technologies
"@ | Out-File -FilePath INSTALL-GUIDE.txt -Encoding UTF8
        
        Write-Host "Installation guide created!"
    
    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: quantum-stealth-windows-installer
        path: QuantumStealth-Setup.exe
        retention-days: 30
    
    - name: Upload Installation Guide  
      uses: actions/upload-artifact@v4
      with:
        name: installation-guide
        path: INSTALL-GUIDE.txt
